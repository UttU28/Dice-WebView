trigger:
- main
# - none

variables:
  azureSubscription: 'dicePipeline'
  resourceGroupName: 'thisresourcegroup'
  acrName: 'thisacr'
  webAppName: 'dicesaralapply1232'
  appServicePlanName: 'thisappserviceplan'
  imageName: 'dicewebview'
  imageTag: 'latest'
  imageRepository: '$(acrName).azurecr.io/$(imageName)'
  codeDirectory: 'src'
  subscriptionID: 'e4cf2944-5342-4787-b990-418828e39bfc'
  acrPassword: 'U9+ivfherZPq3+UWDnj1fxftpOqWUgXqspIc90YYFI+ACRBkerUy'
  artifactName: '$(imageName)_ARTIFACT'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  containerRegistry: 'dockerSC'
  codeScanResults: 'code-scan-results.json'
  trivyResultsPath: 'trivy-results.json'
  checkovResultsPath: 'checkov-results.json'

jobs:
- job: Build
  displayName: 'Build Container Image'
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: Docker@2
    displayName: Build and push an image to container registry
    inputs:
      containerRegistry: '$(containerRegistry)'
      repository: '$(imageName)'
      command: build
      Dockerfile: '$(dockerfilePath)'
      tags: '$(imageTag)art'
  - task: Bash@3
    displayName: Save Docker Image
    inputs:
      targetType: 'inline'
      script: |
        docker save $(imageRepository):$(imageTag)art -o $(Pipeline.Workspace)/$(imageName).tar
  - task: PublishPipelineArtifact@1
    displayName: Publish the Artifact
    inputs:
      targetPath: '$(Pipeline.Workspace)/$(imageName).tar'
      artifact: '$(artifactName)'
      publishLocation: 'pipeline'
  
# - job: CreateAppServicePlan
#   # dependsOn: Build
#   # dependsOn: [CodeScan, CheckovScan, ContainerScan]
#   displayName: 'Create Azure App Service Plan'
#   pool:
#     vmImage: 'ubuntu-latest'
#   steps:

#   - task: AzureCLI@2
#     inputs:
#       azureSubscription: '$(azureSubscription)'
#       scriptType: 'bash'
#       scriptLocation: 'inlineScript'
#       inlineScript: |
#         az appservice plan create --name $(appServicePlanName) --resource-group $(resourceGroupName) --sku B1 --is-linux
#         az webapp create --resource-group $(resourceGroupName) --plan $(appServicePlanName) --name $(webAppName) --assign-identity '[system]' --role acrpull
#         #  --container-image-name $(imageRepository)
#         az webapp config set --resource-group $(resourceGroupName) --name $(webAppName) --generic-configurations '{"acrUseManagedIdentityCreds": true}'

#         az webapp config container set --name $(webAppName) --resource-group $(resourceGroupName) --container-image-name $(imageRepository)
#     displayName: 'Create App Service Plan'

- job: DeployToACR
  displayName: 'Deploy to Azure Container Registry'
  dependsOn: Build
  # dependsOn: CreateAppServicePlan
  pool:
    vmImage: 'ubuntu-latest'
  steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifact: '$(artifactName)'
        targetPath: '$(Pipeline.Workspace)'
    - task: Bash@3
      displayName: Load Docker Image
      inputs:
        targetType: 'inline'
        script: |      
          docker load --input $(Pipeline.Workspace)/$(imageName).tar
          docker tag $(imageRepository):$(imageTag)art $(imageRepository):$(imageTag)
    - task: Docker@2
      displayName: Push an image to container registry
      inputs:
        containerRegistry: '$(containerRegistry)'
        repository: '$(imageName)'
        command: push
        Dockerfile: '$(dockerfilePath)'
        tags: '$(imageTag)'

